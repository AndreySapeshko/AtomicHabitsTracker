# Atomic Habits Tracker — Vision & Architecture

## 1. Цели проекта

Сервис для формирования полезных привычек по принципам книги «Атомные привычки» Джеймса Клира:

- Пользователь создаёт полезные и приятные привычки.
- Сервис присылает напоминания в Telegram по расписанию.
- Пользователь подтверждает выполнение / пропуск.
- Система автоматически фиксирует пропуски и даёт возможность «исправить».
- Ведётся статистика выполнения привычек.

Фокус: **рабочий production-ready backend** (Django + DRF + Celery + Telegram + CI/CD).

---

## 2. Технологический стек

- **Backend**: Django, Django REST Framework
- **База данных**: PostgreSQL
- **Очереди**: Celery + Redis (broker + backend)
- **Планировщик**: Celery beat / APScheduler (будет уточнено в реализации)
- **Интеграция**: Telegram Bot API (webhook или long polling)
- **Тестирование**: pytest, pytest-django, factory_boy
- **Инфраструктура**:
  - Docker / docker-compose (позже)
  - GitHub Actions (CI, потом CD)
- **Стиль кода**: black, flake8, isort (опционально), mypy (опционально)

---

## 3. Высокоуровневая архитектура

Проект разделён на несколько доменных приложений:

- `users` — пользователи и Telegram-профили.
- `habits` — описание привычек (definition).
- `habit_instances` — конкретные запуски привычек (occurrences) и их статусы.
- `telegrambot` — интеграция с Telegram: отправка уведомлений и обработка callback’ов.
- `scheduler` (опционально или как часть habit_instances) — планирование задач и генерация инстансов.
- `core` — общие утилиты, базовые модели, миксины и т.п.

API реализуется через DRF, для каждого домена — свой `api`-слой внутри приложения.

---

## 4. Доменные сущности

### 4.1. User

Стандартный пользователь Django (`auth.User` или кастомная модель, если потребуется).

- Имеет одну запись `TelegramProfile`.
- Является владельцем привычек (`Habit`).

### 4.2. TelegramProfile

Привязка пользователя к Telegram.

- `user` — FK на User (1:1).
- `chat_id` — идентификатор чата в Telegram.
- `timezone` — часовой пояс пользователя.
- `is_active` — флаг активности уведомлений.

### 4.3. Habit (определение привычки)

Описывает **что**, **где**, **когда** и **как часто** делает пользователь.

Поля (ключевые):

- `user` — владелец привычки.
- `action` — действие (что делать).
- `place` — место выполнения.
- `time_of_day` — время дня для напоминания.
- `periodicity_days` — периодичность в днях (1 — ежедневно, 7 — раз в неделю и т.д.).
- `is_pleasant` — флаг приятной привычки.
- `related_pleasant_habit` — ссылка на приятную привычку как награду (для полезных).
- `reward_text` — текстовая награда (если не используется pleasant habit).
- `is_public` — флаг публичности.
- `is_active` — активна ли привычка.
- `grace_minutes` — окно ожидания подтверждения выполнения.
- `fix_minutes` — окно исправления статуса после авто-пропуска.
- `repeat_limit` — количество повторений (21/30/45), после которого привычка автоматически завершается.

Бизнес-правила:

- Если `is_pleasant=True`:
  - `reward_text` и `related_pleasant_habit` должны быть пустыми.
- Если `is_pleasant=False` (полезная привычка):
  - Должно быть **ровно одно** из: `reward_text` или `related_pleasant_habit`.
  - `related_pleasant_habit` должна быть приятной (`is_pleasant=True`) и того же пользователя.
- `repeat_limit` — количество запусков привычки, не дней.

### 4.4. HabitInstance (запуск привычки)

Конкретное выполнение привычки в определённую дату/время.

Поля:

- `habit` — ссылка на Habit.
- `scheduled_datetime` — когда привычка должна быть выполнена.
- `confirm_deadline` — крайний срок подтверждения (окно ожидания).
- `fix_deadline` — крайний срок исправления статуса.
- `status` — состояние:
  - `scheduled`
  - `pending`
  - `completed`
  - `missed`
  - `completed_late`
  - `fix_expired`
- `completed_at` — фактическое время подтверждённого выполнения (если есть).

Статусы управляются системой и действиями пользователя.

---

## 5. Основные сценарии

### 5.1. Создание привычки

1. Пользователь создаёт привычку через SPA (REST API).
2. Указывает:
   - действие / место / время / периодичность
   - тип: полезная / приятная
   - награду (текстовую или pleasant habit)
   - публичность
   - при необходимости — `repeat_limit` (21/30/45)
3. Система:
   - валидирует бизнес-правила.
   - автоматически вычисляет `grace_minutes` и `fix_minutes` на основе периодичности.
   - помечает привычку `is_active=True`.

### 5.2. Планирование запусков

- Планировщик (Celery beat / APScheduler):
  - для активных привычек и не превышенного `repeat_limit` создаёт `HabitInstance` с `scheduled_datetime`.
  - использует `periodicity_days` и `time_of_day`.
- Выполнение не влияет на расписание — следующая дата считается строго по периодичности, пока:
  - `is_active=True` и
  - количество инстансов < `repeat_limit` (если задан).

### 5.3. Уведомления и подтверждение

1. В момент `scheduled_datetime`:
   - создаётся или активируется `HabitInstance` со статусом `scheduled → pending`.
   - Telegram Bot отправляет пользователю сообщение с кнопками:
     - «✔ Выполнил»
     - «✖ Пропустить»
2. В течение `grace_minutes`:
   - при нажатии «✔» → `status=completed`, `completed_at=now`, отправляется награда.
   - при нажатии «✖» → `status=missed`.

### 5.4. Автоматический пропуск и окно исправления

- По истечении `confirm_deadline`:
  - если статус всё ещё `pending` → система ставит `status=missed`.
  - отправляет сообщение с кнопкой «✔ Я выполнил».
- До `fix_deadline`:
  - при нажатии кнопки → `status=completed_late`.
- После `fix_deadline`:
  - статус финализируется → `fix_expired`.

---

## 6. Приложения Django

- `users`:
  - модели пользователя (если кастомный User)
  - `TelegramProfile`
  - API: регистрация, профили, привязка Telegram.
- `habits`:
  - модель `Habit`
  - бизнес-валидация
  - API: CRUD привычек, публичный список.
- `habit_instances`:
  - модель `HabitInstance`
  - сервисы изменения статуса
  - API: история выполнения (read-only).
- `telegrambot`:
  - обработка вебхуков / поллинга
  - отправка сообщений
  - обработка callback’ов от кнопок
- `scheduler` (или внутри `habit_instances`):
  - celery tasks / APScheduler jobs
  - генерация HabitInstance
  - проверка дедлайнов, повторов
- `core`:
  - общие utils, базовые классы и миксины.

---

## 7. API

### Примеры:

- `/api/auth/` — аутентификация, получение токенов.
- `/api/habits/` — CRUD привычек.
- `/api/habits/public/` — публичные привычки.
- `/api/habits/{id}/stats/` — статистика по привычке (агрегация HabitInstance).
- `/api/instances/` — список запусков (история, фильтры по датам / статусам).
- `/api/telegram/webhook/` — точка входа для Telegram (если вебхуки).

---

## 8. CI / CD

- Git ветки:
  - `main` — production.
  - `develop` — основная интеграционная ветка.
  - `draft` — рабочая ветка разработки.
- CI (GitHub Actions):
  - триггер: Pull Request → `develop`.
  - шаги: установка зависимостей, миграции, `flake8`, `black --check`, `pytest`.
- CD:
  - позже: при merge в `main` — deploy через Docker и GitHub Actions на сервер.

---
