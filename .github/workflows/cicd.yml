name: AtomicHabits CI/CD

on:
  pull_request:
    branches: [develop]

  push:
    branches: [main]


jobs:
  # -----------------------------
  # 1. Backend Lint & Migrations
  # -----------------------------
  lint:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y libpq-dev build-essential

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Install backend deps
        run: poetry install --no-root --no-interaction

      - name: Black
        run: poetry run black . --check

      - name: Flake8
        run: poetry run flake8 .

      - name: Check migrations
        run: poetry run python manage.py makemigrations --check --dry-run


  # -----------------------------
  # 2. Backend tests
  # -----------------------------
  backend-tests:
    needs: lint
    runs-on: ubuntu-latest
    env:
      DJANGO_ENV: "ci"

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install Poetry
        run: pip install poetry

      - name: Install deps
        run: poetry install --no-root --no-interaction

      - name: Run migrations
        run: poetry run python manage.py migrate --noinput

      - name: Run backend tests
        run: |
          export DJANGO_SETTINGS_MODULE=atomic_habits_tracker.settings.ci
          poetry run pytest --verbosity=2


  # -----------------------------
  # 3. Frontend tests (Vitest/Jest)
  # -----------------------------
  frontend-tests:
    needs: backend-tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install frontend deps
        run: |
          cd aht_app_frontend/habit-frontend
          npm ci

      - name: Run frontend tests
        run: |
          cd aht_app_frontend/habit-frontend
          npm run test -- --run


  # -----------------------------
  # 4. Frontend build (Vite)
  # -----------------------------
  frontend-build:
    needs: frontend-tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install deps
        run: |
          cd aht_app_frontend/habit-frontend
          npm ci

      - name: Build frontend
        run: |
          cd aht_app_frontend/habit-frontend
          npm run build


  # -----------------------------
  # 5. Docker Build + Push to GHCR
  # -----------------------------
  docker-build:
    needs: frontend-build
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read

    steps:
      - uses: actions/checkout@v3

      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Normalize owner to lowercase
        run: echo "IMAGE_OWNER=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Build backend image
        run: |
          docker build \
            -t ghcr.io/${IMAGE_OWNER}/atomic-backend:${GITHUB_SHA} \
            -f docker/backend/Dockerfile .

      - name: Push backend
        run: docker push ghcr.io/${IMAGE_OWNER}/atomic-backend:${GITHUB_SHA}

      - name: Build frontend image
        run: |
          docker build \
            -t ghcr.io/${IMAGE_OWNER}/atomic-frontend:${GITHUB_SHA} \
            -f docker/frontend/Dockerfile .

      - name: Push frontend
        run: docker push ghcr.io/${IMAGE_OWNER}/atomic-frontend:${GITHUB_SHA}



  # -----------------------------
  # 6. Deploy to VPS (main branch only)
  # -----------------------------
  deploy:
    if: github.ref == 'refs/heads/main'
    needs: docker-build
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to production server
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            cd /home/andrs/projects/AtomicHabitsTracker
            
            export IMAGE_TAG=${{ github.sha }}
            
            echo "ðŸš€ Pulling latest images..."
            docker-compose pull

            echo "ðŸš€ Restarting services..."
            docker-compose up -d --build --force-recreate

            echo "ðŸŽ‰ Deploy complete!"
